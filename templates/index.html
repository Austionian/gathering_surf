<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const qualities = {{ qualities | safe }}
    const wave_height_labels = [{{ wave_height_labels | safe }}]
    const wave_heights = [{{ wave_height_data }}]
    const wind_speeds = [{{ wind_speed_data }}]
    const wind_directions = [{{ wind_direction_data }}]

    document.querySelector("#legend").setAttribute("style", "background-color: {{ wave_quality }};")
    document.querySelector("#legend-label").innerText = wave_height_labels[0];
    document.querySelector("#legend-wave-height").innerText = wave_heights[0];
    document.querySelector("#legend-wind-speed").innerText = wind_speeds[0];
    document.getElementById("legend-wind-icon").setAttribute("style", `transform: rotate(${wind_directions[0]}deg);`)

    document.getElementById("wave-quality").setAttribute("style", "background-color: {{ wave_quality }};")
    document.getElementById("wave-quality-text").innerText = "{{ wave_quality_text }}"
    document.getElementById("wave-quality-text").setAttribute("style", "color: {{ wave_quality }};")
    document.getElementById("current-wave-height").innerText = "{{ current_wave_height }}"
    document.getElementById("current-wave-period").innerText = "{{ current_wave_period }}"
    document.getElementById("current-water-temp").innerText = "{{ current_water_temp }}"
    document.getElementById("current-air-temp").innerText = "{{ current_air_temp }}"
    document.getElementById("wave-icon").setAttribute("style", "transform: rotate({{ current_wave_direction }}deg);")
    document.getElementById("wind").innerText = "{{ wind }}"
    document.getElementById("as-of").innerText = "Live as of {{ as_of }}"
    document.getElementById("wind-icon").setAttribute("style", "transform: rotate({{ wind_icon_direction }}deg);")
    document.getElementById("forecast-as-of").innerText = "Last updated at {{ forecast_as_of }}"

    document.querySelectorAll(".loader").forEach(e => e.remove())
    document.getElementById("wind-icon-container").classList.remove("hidden")
    document.getElementById("wave-icon-container").classList.remove("hidden")
    document.getElementById("as-of-container").classList.remove("animate-pulse")
    document.getElementById("forecast").classList.remove("hidden")
    document.getElementById("wave-quality").classList.remove("hidden")

const ctx = document.getElementById("forecast");

const quality = ctx => qualities[ctx.p0.parsed.x]

const plugin = {
    id: 'vert',
    defaults: {
        width: 1,
        dash: [3, 3],
    },
    afterInit: (chart, args, opts) => {
      chart.corsair = {
        x: 0,
        y: 0,
      }
    },
    afterEvent: (chart, args) => {
      const {inChartArea} = args
      const {type,x,y} = args.event

      chart.corsair = {x, y, draw: inChartArea}
      chart.draw()
    },
    beforeDatasetsDraw: (chart, args, opts) => {
      const {ctx} = chart
      const {top, bottom, left, right} = chart.chartArea
      const {x, draw} = chart.corsair
      if (!draw) return

      ctx.save()
      
      ctx.beginPath()
      ctx.lineWidth = opts.width
      ctx.strokeStyle = opts.color
      ctx.setLineDash(opts.dash)
      ctx.moveTo(x, bottom)
      ctx.lineTo(x, top)
      ctx.stroke()
      
      ctx.restore()
    }
  }

console.log(wave_height_labels, wave_heights.length )

new Chart(ctx, {
  type: "line",
  plugins: [plugin],
  data: {
    labels: wave_height_labels, 
    datasets: [
      {
        label: "wave height (feet)",
        data: wave_heights,
        pointStyle: false,
        fill: false,
        segment: {
          backgroundColor: (ctx) => quality(ctx) || "#4ade80",
          borderColor: (ctx) => quality(ctx) || "#4ade80",
        },
      },
    ],
  },
  options: {
        onHover: (e, _, chart) => {
            const canvasPosition = Chart.helpers.getRelativePosition(e, chart);
            // Substitute the appropriate scale IDs
            const x_value = chart.scales.x.getValueForPixel(canvasPosition.x) 
            const x = x_value && x_value > 0 
                ? x_value > wave_heights.length 
                    ? wave_heights.length 
                    : x_value 
                : 0;
            const color = qualities[x];
            document.querySelector("#legend").setAttribute("style", `background-color: ${ color }`);
            document.querySelector("#legend-label").innerText = wave_height_labels[x];
            document.querySelector("#legend-wave-height").innerText = wave_heights[x];
            document.querySelector("#legend-wind-speed").innerText = wind_speeds[x];
            document.getElementById("legend-wind-icon").setAttribute("style", `transform: rotate(${wind_directions[x]}deg);`)
        },
    plugins: {
      legend: {
        display: false,
      },
    vert: {
      color: 'white',
    },
      tooltip: {
        enabled: false,
      },
    },
    elements: {
      line: {
        tension: 0.4,
      },
    },
    responsive: true,
    interaction: {
      intersect: false,
      axis: "x",
    },
    scales: {
      x: {
        ticks: {
          display: false,
        },
      },
      y: {
        beginAtZero: true,
        max: {{ graph_max }} + 1,
      },
    },
  },
});
</script>
</body>
</html>
